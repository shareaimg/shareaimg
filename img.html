<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML 转图片工具（iframe + html2canvas，支持 JS 执行）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; }
        iframe { width: 100%; min-height: 400px; border: 1px solid #ccc; margin-top: 20px; }
        button { padding: 10px 20px; margin-right: 10px; }
        #output { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>HTML 代码转图片工具（支持 JavaScript 执行）</h1>
    <p>输入完整 HTML（可包含 &lt;script&gt;），iframe 会执行脚本后渲染。</p>
    
    <textarea id="htmlInput" placeholder="输入完整 HTML，包括 &lt;html&gt;&lt;head&gt;&lt;body&gt; 和 &lt;script&gt;">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;style&gt;
        body { font-family: Arial; text-align: center; padding: 50px; background: #f0f0f0; }
        canvas { border: 1px solid #000; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;动态图表示例（Chart.js）&lt;/h1&gt;
    &lt;canvas id="myChart" width="600" height="400"&gt;&lt;/canvas&gt;

    &lt;script src="https://cdn.jsdelivr.net/npm/chart.js"&gt;&lt;/script&gt;
    &lt;script&gt;
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['红', '蓝', '黄', '绿', '紫', '橙'],
                datasets: [{
                    label: '投票数',
                    data: [12, 19, 3, 5, 2, 3],
                    backgroundColor: 'rgba(75, 192, 192, 0.6)'
                }]
            }
        });
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
    </textarea>
    
    <button onclick="previewInIframe()">在 iframe 中预览（执行 JS）</button>
    <button onclick="generateImage()">生成图片并下载</button>
    <p><small>提示：复杂脚本可能需要多等几秒再点击生成图片。</small></p>

    <h2>iframe 预览区域</h2>
    <iframe id="previewIframe"></iframe>

    <h2>生成的图片预览</h2>
    <div id="output"></div>

    <script>
        let iframeLoaded = false;

        function previewInIframe() {
            const input = document.getElementById('htmlInput').value.trim();
            const iframe = document.getElementById('previewIframe');
            const output = document.getElementById('output');
            output.innerHTML = '';

            if (!input) {
                alert('请输入 HTML 代码！');
                return;
            }

            // 写入 iframe（使用 blob URL 保持同源）
            const blob = new Blob([input], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            iframe.src = url;

            // 监听加载完成
            iframe.onload = () => {
                iframeLoaded = true;
                alert('iframe 加载完成，JS 已开始执行。请稍等动态内容渲染完毕后再生成图片。');
            };
        }

        async function generateImage() {
            const iframe = document.getElementById('previewIframe');
            if (!iframeLoaded || !iframe.contentDocument || !iframe.contentDocument.body) {
                alert('请先点击“在 iframe 中预览”并等待加载完成！');
                return;
            }

            const target = iframe.contentDocument.body;  // 或指定某个 div: iframe.contentDocument.getElementById('container')

            // 额外等待动态内容渲染（可根据需要调整）
            await new Promise(resolve => setTimeout(resolve, 2000)); // 建议 1-3 秒

            const canvas = await html2canvas(target, {
                scale: 2,
                useCORS: true,           // 尝试处理跨域图片
                allowTaint: false,
                logging: true,
                width: target.scrollWidth,
                height: target.scrollHeight,
                scrollX: 0,
                scrollY: 0
            });

            // 显示并下载
            const output = document.getElementById('output');
            output.innerHTML = '';
            output.appendChild(canvas);

            const link = document.createElement('a');
            link.download = 'html-to-image-with-js.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
